      PROGRAM BI2RLV2
      IMPLICIT REAL*16 (A-H,O-Z)
      COMMON ALPHA,P1L,Q1L,P2L,Q2L,RHO1L,RHO2L,RHOAL,RHO1,RHO2
      COMMON GAM1(0:2000),GAM2(0:2000)
      COMMON POWC(0:2000),FAKL(0:2000)
      COMMON HYP01(-1:2000),HYP02(-1:2000),HYPA(-1:2000)
      COMMON IC1(0:2000),IC2(0:2000)
      OPEN(UNIT=5, STATUS='OLD', FILE='rlv2_inp')
      OPEN(UNIT=6, STATUS='UNKNOWN', FILE='rlv2_out')
      READ(5,9000) RHO1,RHO2,ALPHA,P1,P2,BETA,QLAMBD
 9000 FORMAT(6(F10.8/),F10.5)     
      WRITE (6,1000) RHO1,RHO2,ALPHA,P1,P2,BETA,QLAMBD
      ALPHA=1-ALPHA
      BETA=1-BETA
      RHO1L=QLOG(RHO1)
      RHO2L=QLOG(RHO2)
      P1L=QLOG(P1)
      Q1L=QLOG(1-P1)
      P2L=QLOG(P2)
      Q2L=QLOG(1-P2)
      RHOAL=P1L+Q2L-Q1L-P2L
      FAKL(0)=0
      DO 1 I=1,2000
      QI=I
    1 FAKL(I)=FAKL(I-1)+QLOG(QI)
      N=100
    2 QM=QLAMBD*N
      M=QINT(QM)
      M=M+.5*(1-QSIGN(1.Q0,M-QM))
      POW=PWEXACT(M,N)
      IF (POW-BETA)20,17,17
   17 N=N+100
      IF ((1+QLAMBD)*N-2000)2,2,19
   19 WRITE(6,999)
  999 FORMAT('SUMME DER BENOETIGTEN STICHPROBENUMFAENGE >2000')
      STOP
   20 N = N-100
   21 N = N+10   
      QM=QLAMBD*N
      M=QINT(QM)
      M=M+.5*(1-QSIGN(1.Q0,M-QM))
      POW=PWEXACT(M,N)
      IF (POW-BETA)22,21,21
   22 N=N-10
   23 N=N+1;  
      QM=QLAMBD*N
      M=QINT(QM)
      M=M+.5*(1-QSIGN(1.Q0,M-QM))
      POW=PWEXACT(M,N)
      IF (POW-BETA) 30,23,23
   30 POW=1-POW  
      WRITE(6,2000) M,N,POW
 1000 FORMAT('RHO1= ',F6.4,3X,'RHO2= ',F7.4,8X,'ALPHA= ',F5.4/
     1'P1=   ',F10.8,3X,'P2=   ',F10.8/
     2'BETA= ',F10.8,3X,'LAMBDA= ',F5.2//)
 2000 FORMAT('M= ',I4,5X,'N= ',I4,8X,'POW= ',F10.8)
      STOP
      END
      REAL FUNCTION PWEXACT*16(M,N)
      IMPLICIT REAL*16 (A-H,O-Z)
      COMMON ALPHA,P1L,Q1L,P2L,Q2L,RHO1L,RHO2L,RHOAL,RHO1,RHO2
      COMMON GAM1(0:2000),GAM2(0:2000)
      COMMON POWC(0:2000),FAKL(0:2000)
      COMMON HYP01(-1:2000),HYP02(-1:2000),HYPA(-1:2000)
      COMMON IC1(0:2000),IC2(0:2000)
      NN=M+N
      IS=0
      OOM01L=0
      OOM02L=0
      OOMAL=0
      IC1(IS)=0
      GAM1(IS)=ALPHA
      IC2(IS)=0
      GAM2(IS)=ALPHA
      POWC(IS)=ALPHA
      PROBS=QEXP(M*Q1L+N*Q2L)
      POW=POWC(0)*PROBS
      DO 9 IS=1,NN-1
      IXL=MAX(0,IS-N)
      IXU=MIN(IS,M)
      IXEINS=IS*M/NN
      HYP01(IXU)=0
      HYP02(IXU)=0
      HYPA(IXU)=0
      DO 2 J=1,IXU-IXL+1
      IX=IXU-J
      HL=FAKL(M)-FAKL(IX+1)-FAKL(M-IX-1)+FAKL(N)-FAKL(IS-IX-1)-
     1FAKL(N-IS+IX+1)
      HYP01(IX)=QEXP(HL+(IX+1)*RHO1L -OOM01L)
      HYP02(IX)=QEXP(HL+(IX+1)*RHO2L -OOM02L)
      HYPA(IX)=QEXP(HL+(IX+1)*RHOAL -OOMAL)
      HYP01(IX)=HYP01(IX)+HYP01(IX+1)
      HYP02(IX)=HYP02(IX)+HYP02(IX+1)
    2 HYPA(IX)=HYPA(IX)+HYPA(IX+1)
      OOM01L=OOM01L+QLOG(HYP01(IXL-1))
      OOM02L=OOM02L+QLOG(HYP02(IXL-1))
      OOMAL=OOMAL+QLOG(HYPA(IXL-1))
      DO 3 IX=IXL, IXU-1
      HYP01(IX)=HYP01(IX)/HYP01(IXL-1)
      HYP02(IX)=HYP02(IX)/HYP02(IXL-1)
    3 HYPA(IX)=HYPA(IX)/HYPA(IXL-1)
      HYP01(IXL-1)=1
      HYP02(IXL-1)=1
      HYPA(IXL-1)=1
      K=IXEINS
      IF(2*K.LT.IS.OR.RHO1.NE.1/RHO2) GOTO 300
      HRHO1K=HYP01(K)-HYP01(K+1)
      IF (HRHO1K.GE.ALPHA) GOTO 36
  300 K1=MIN(K+5,IS,M)
   30 K2=K1-1
      HRHO1C1=HYP01(K1-1)
      HRHO2C1=HYP02(K1-1)
    5 ALPHA1=HRHO1C1-HYP01(K2)
      ALPHA2=HRHO2C1-HYP02(K2)
      IF (QMAX1(ALPHA1,ALPHA2)-ALPHA) 6,6,7
    6 K2=K2+1
      IF (K2.GT.IS) GOTO 35       
      GOTO 5
    7 K2=K2-1
      IF (K2.LT.K1) GOTO 32
      K1=K1+1
      INC_L=0
      INC_R=1
   31 ALPHA1=HYP01(K1-1)-HYP01(K2)
      ALPHA2=HYP02(K1-1)-HYP02(K2)
      DELALPH1=ALPHA-ALPHA1
      DELALPH2=ALPHA-ALPHA2
      EXHYP11=HYP01(K1-2)-HYP01(K1-1)
      EXHYP12=HYP01(K2)-HYP01(K2+1)
      EXHYP21=HYP02(K1-2)-HYP02(K1-1)
      EXHYP22=HYP02(K2)-HYP02(K2+1)
      DET=EXHYP11*EXHYP22-EXHYP12*EXHYP21
      GAMMA1=(EXHYP22*DELALPH1-EXHYP12*DELALPH2)/DET
      GAMMA2=(EXHYP11*DELALPH2-EXHYP21*DELALPH1)/DET
      IF ((QMIN1(GAMMA1,GAMMA2).LT.0.OR.QMAX1(GAMMA1,GAMMA2).GE.1.)
     1.AND.INC_L.EQ.0.AND.INC_R.EQ.1) GOTO 33
      IF ((QMIN1(GAMMA1,GAMMA2).LT.0.OR.QMAX1(GAMMA1,GAMMA2).GE.1.)
     1.AND.INC_L.EQ.1.AND.INC_R.EQ.0) GOTO 34
      IF ((QMIN1(GAMMA1,GAMMA2).LT.0.OR.QMAX1(GAMMA1,GAMMA2).GE.1.)
     1.AND.INC_L.EQ.1.AND.INC_R.EQ.1) GOTO 35
      GOTO 39
   32 INC_L=1
      INC_R=1
      GOTO 31
   33 K1=K1-1
      K2=K2-1
      INC_L=1
      INC_R=0
      GOTO 31
   34 K2=K2+1
      INC_L=1
      INC_R=1
      GOTO 31
   35 K1=K1-1
      GOTO 30
   36 C1=K
      C2=K
      GAMMA1=ALPHA/HRHO1K
      GAMMA2=GAMMA1
   39 IC1(IS)=K1-1
      IC2(IS)=K2+1
      GAM1(IS)=GAMMA1
      GAM2(IS)=GAMMA2
      PAGTC1=HYPA(IC1(IS))
      PAGTC1MI=HYPA(IC1(IS)-1)
      PAGTC2MI=HYPA(IC2(IS)-1)
      PAGTC2=HYPA(IC2(IS))
      IC1EQC2=0
      IF(IC1(IS).EQ.IC2(IS)) IC1EQC2=1
      POWNRC=(PAGTC1-PAGTC2MI)*(1-IC1EQC2)
      POWC(IS)=POWNRC+GAM1(IS)*(PAGTC1MI-PAGTC1)*(1-.5*IC1EQC2)+
     1GAM2(IS)*(PAGTC2MI-PAGTC2)*(1-.5*IC1EQC2)
      PROBS=0
      DO 8  IX=IXL,IXU
      BL=FAKL(N)-FAKL(IS-IX)-FAKL(N-IS+IX)+(IS-IX)*P2L+(N-IS+IX)
     1*Q2L+FAKL(M)-FAKL(IX)-FAKL(M-IX)+IX*P1L+(M-IX)*Q1L
    8 PROBS=PROBS+QEXP(BL)
    9 POW=POW+POWC(IS)*PROBS
      POWC(NN)=ALPHA
      PROBS=QEXP(M*P1L+N*P2L)
      PWEXACT=POW+POWC(NN)*PROBS
      RETURN
      END
